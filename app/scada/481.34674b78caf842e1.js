"use strict";(self.webpackChunkscada=self.webpackChunkscada||[]).push([[481],{4808:(B,v,o)=>{o.r(v),o.d(v,{ViewerModule:()=>z});var y=o(6895),g=o(4575),b=o(760),i=o(4650),w=o(1481),V=o(1445),C=o(5582),M=o(387),j=o(4838);const O=[{path:":id",component:(()=>{class t{constructor(s,e,p,a,r,u,f){this.title=s,this.element=e,this.rs=p,this.cs=a,this.route=r,this.ns=u,this.mqtt=f,this.id="",this.index=0,this.subs=[];let m=r.snapshot.queryParams.mousewheel,d=r.snapshot.queryParams.panning;this.graph=new b.kJ({container:e.nativeElement,interacting:!1,mousewheel:"true"==m||"1"==m,panning:"true"==d||"1"==d}),this.graph.on("cell:click",({cell:n,e:c})=>{try{n.data.listeners?.click?.call(this,n,c),this.cs.Get(n.shape)?.listeners?.click?.call(this,n,c)}catch(h){this.ns.error("\u70b9\u51fb\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",h.message)}}),this.graph.on("cell:mouseenter",({cell:n,e:c})=>{try{this.cs.Get(n.shape)?.listeners?.mouseenter?.call(this,n,c)}catch(h){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",h.message)}}),this.graph.on("cell:mouseleave",({cell:n,e:c})=>{try{this.cs.Get(n.shape)?.listeners?.mouseleave?.call(this,n,c)}catch(h){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",h.message)}}),this.graph.on("cell:custom",n=>{try{n.cell?.data.listeners?.[n.event]?.call(this,n.cell,n.value)}catch(c){this.ns.error("\u7ec4\u4ef6\u4e8b\u4ef6\u54cd\u5e94\u5904\u7406\u9519\u8bef",c.message)}})}Render(s){s.content?.cells?.forEach(e=>{this.cs.Get(e.shape)}),this.graph.drawBackground({color:s.background_color,image:s.background_image}),this.graph.fromJSON(s.content),this.subs.forEach(e=>e.unsubscribe()),this.subs=[],this.graph.getCells().forEach(e=>{const p=this.cs.Get(e.shape);for(const a in e.data.bindings){if(!e.data.bindings.hasOwnProperty(a))continue;const r=e.data.bindings[a];console.log("binding",p.id,a,r);const f=this.mqtt.observe(`up/property/${r.product}/${r.device}`).subscribe(m=>{const d=JSON.parse(m.payload.toString());console.log("data",p.id,a,r,d);try{p.hooks?.[a]?.call(this,e,d[r.variable])}catch(n){this.ns.error("\u6570\u636e\u7ed1\u5b9a\u9519\u8bef",n.message)}});this.subs.push(f)}for(const a in e.data.listeners){if(!e.data.listeners.hasOwnProperty(a))continue;const r=e.data.listeners[a];if("string"==typeof r&&r.length>0)try{e.data.listeners[a]=new Function("cell","event",r)}catch(u){this.ns.error("\u7f16\u8bd1\u9519\u8bef",u.message)}}})}ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),this.rs.get(`api/project/${this.id}`).subscribe(s=>{this.project=s.data,this.title.setTitle(this.project.name),this.Render(this.project.pages[0])})}ngOnDestroy(){this.subs.forEach(s=>s.unsubscribe())}handlePageChange(s){this.Render(this.project.pages[this.index])}}return t.\u0275fac=function(s){return new(s||t)(i.Y36(w.Dx),i.Y36(i.SBq),i.Y36(V.s),i.Y36(C.m),i.Y36(g.gz),i.Y36(M.zb),i.Y36(j.KZ))},t.\u0275cmp=i.Xpm({type:t,selectors:[["app-viewer"]],decls:0,vars:0,template:function(s,e){},styles:["[_nghost-%COMP%]{display:block;width:100%!important;height:100%!important}"]}),t})()}];let Y=(()=>{class t{}return t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=i.oAB({type:t}),t.\u0275inj=i.cJS({imports:[g.Bz.forChild(O),g.Bz]}),t})(),z=(()=>{class t{}return t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=i.oAB({type:t}),t.\u0275inj=i.cJS({imports:[y.ez,Y]}),t})()}}]);