"use strict";(self.webpackChunkscada=self.webpackChunkscada||[]).push([[773],{773:(F,v,h)=>{h.r(v),h.d(v,{ViewerModule:()=>W});var b=h(6895),m=h(4575),z=h(760),s=h(4650),y=h(1481),f=h(5156);const j=["iframe"];function M(i,l){if(1&i&&(s.TgZ(0,"div"),s._uU(1),s.qZA()),2&i){const t=s.oxw();s.xp6(1),s.Oqu(t.title)}}let T=(()=>{class i{set url(t){this.safeUrl=this.san.bypassSecurityTrustResourceUrl(t)}constructor(t){this.san=t,this.title="\u7a97\u53e3",this.width=400,this.height=300}load(t){console.log("iframe load",t);const e=this.iframe.nativeElement.contentWindow;this.title=e.document.title,setTimeout(()=>{this.title=e.document.title},500),setTimeout(()=>{this.title=e.document.title},2e3)}}return i.\u0275fac=function(t){return new(t||i)(s.Y36(y.H7))},i.\u0275cmp=s.Xpm({type:i,selectors:[["app-window"]],viewQuery:function(t,e){if(1&t&&s.Gf(j,5),2&t){let c;s.iGM(c=s.CRH())&&(e.iframe=c.first)}},inputs:{title:"title",width:"width",height:"height",url:"url"},decls:3,vars:5,consts:[[4,"nzModalTitle"],[3,"src","load"],["iframe",""]],template:function(t,e){1&t&&(s.YNc(0,M,2,1,"div",0),s.TgZ(1,"iframe",1,2),s.NdJ("load",function(r){return e.load(r)}),s.qZA()),2&t&&(s.xp6(1),s.Udp("width",e.width+"px")("height",e.height+"px"),s.Q6J("src",e.safeUrl,s.uOi))},dependencies:[f.h1],styles:["iframe[_ngcontent-%COMP%]{border:none}"]}),i})();var V=h(1445),O=h(7638),C=h(387),Y=h(4838);const R=[{path:":id",component:(()=>{class i{constructor(t,e,c,r,a,u,g,w){function p(n){let o=a.snapshot.queryParams[n];return"true"==o||"1"==o}this.title=t,this.element=e,this.rs=c,this.cs=r,this.route=a,this.ns=u,this.ms=g,this.mqtt=w,this.id="",this.index=0,this.subs=[],this.mousewheel=!1,this.panning=!1,this.center=!1,this.fit=!1,this.tools={go:n=>{this.project.pages.forEach(o=>{o.name==n&&this.Render(o)})},window:(n,o=400,d=300,x="\u7a97\u53e3")=>{this.ms.create({nzContent:T,nzComponentParams:{url:n,width:o,height:d,title:x},nzWidth:o+48,nzFooter:null})},open:(n,o=!1)=>{o?window.open(n):location.href=n}},this.load(),this.mousewheel=p("mousewheel"),this.panning=p("panning"),this.center=p("center"),this.fit=p("fit"),this.graph=new z.kJ({container:e.nativeElement,interacting:!1,mousewheel:this.mousewheel,panning:this.panning}),this.graph.on("cell:click",({cell:n,e:o})=>{try{n.data?.listeners?.click?.call(this,n,o,this.tools),this.cs.Get(n.shape)?.listeners?.click?.call(this,n,o,this.tools)}catch(d){this.ns.error("\u70b9\u51fb\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:mouseenter",({cell:n,e:o})=>{try{this.cs.Get(n.shape)?.listeners?.mouseenter?.call(this,n,o,this.tools)}catch(d){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:mouseleave",({cell:n,e:o})=>{try{this.cs.Get(n.shape)?.listeners?.mouseleave?.call(this,n,o,this.tools)}catch(d){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:custom",n=>{try{n.cell?.data.listeners?.[n.event]?.call(this,n.cell,n.value,this.tools)}catch(o){this.ns.error("\u7ec4\u4ef6\u4e8b\u4ef6\u54cd\u5e94\u5904\u7406\u9519\u8bef",o.message)}})}evaluate(t,e){const c=Object.keys(e),r=Object.values(e);return new Function(...c,"return "+t)(...r)}Render(t){t.content?.cells?.forEach(e=>{this.cs.Get(e.shape)}),this.graph.drawBackground({color:t.background_color,image:t.background_image}),this.graph.fromJSON(t.content),this.center&&this.graph.centerContent(),this.fit&&this.graph.zoomToFit(),this.subs.forEach(e=>e.unsubscribe()),this.subs=[],this.graph.getCells().forEach(e=>{const c=this.cs.Get(e.shape);if(e.data?.bindings)for(const r in e.data.bindings){if(!e.data.bindings.hasOwnProperty(r))continue;const a=e.data.bindings[r];console.log("binding",c.id,r,a);const g=this.mqtt.observe(`up/property/${a.product}/${a.device}`).subscribe(w=>{const p=JSON.parse(w.payload.toString());console.log("data",c.id,r,a,p);try{c.hooks?.[r]?.call(this,e,p[a.variable])}catch(n){this.ns.error("\u6570\u636e\u7ed1\u5b9a\u9519\u8bef",n.message)}});this.subs.push(g)}if(e.data?.listeners)for(const r in e.data.listeners){if(!e.data.listeners.hasOwnProperty(r))continue;const a=e.data.listeners[r];if("string"==typeof a&&a.length>0)try{e.data.listeners[r]=new Function("cell","event","tools",a)}catch(u){this.ns.error("\u811a\u672c\u7f16\u8bd1\u9519\u8bef"+r,a+" "+u.message),e.data.listeners[r]=()=>{this.ns.error("\u7ec4\u4ef6\u811a\u672c\u9519\u8bef"+r,a+" "+u.message)}}}})}load(){this.id=this.route.snapshot.paramMap.get("id"),this.rs.get(`api/project/${this.id}`).subscribe(t=>{this.project=t.data,this.title.setTitle(this.project.name),this.graph.resize(this.project.width,this.project.height),this.Render(this.project.pages[0])})}ngOnDestroy(){this.subs.forEach(t=>t.unsubscribe())}handlePageChange(t){this.Render(this.project.pages[this.index])}}return i.\u0275fac=function(t){return new(t||i)(s.Y36(y.Dx),s.Y36(s.SBq),s.Y36(V.s),s.Y36(O.m),s.Y36(m.gz),s.Y36(C.zb),s.Y36(f.Sf),s.Y36(Y.KZ))},i.\u0275cmp=s.Xpm({type:i,selectors:[["app-viewer"]],decls:0,vars:0,template:function(t,e){},styles:["[_nghost-%COMP%]{display:block}"]}),i})()}];let S=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=s.oAB({type:i}),i.\u0275inj=s.cJS({imports:[m.Bz.forChild(R),m.Bz]}),i})(),W=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=s.oAB({type:i}),i.\u0275inj=s.cJS({imports:[b.ez,S,C.L8,f.Qp]}),i})()}}]);