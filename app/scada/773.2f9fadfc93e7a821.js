"use strict";(self.webpackChunkscada=self.webpackChunkscada||[]).push([[773],{773:(J,v,c)=>{c.r(v),c.d(v,{ViewerModule:()=>B});var C=c(6895),m=c(4575),z=c(760),s=c(4650),y=c(1481),g=c(5156);const V=["iframe"];function T(n,l){if(1&n&&(s.TgZ(0,"div"),s._uU(1),s.qZA()),2&n){const t=s.oxw();s.xp6(1),s.Oqu(t.title)}}let j=(()=>{class n{set url(t){this.safeUrl=this.san.bypassSecurityTrustResourceUrl(t)}constructor(t){this.san=t,this.title="\u7a97\u53e3",this.width=400,this.height=300}load(t){console.log("iframe load",t);const e=this.iframe.nativeElement.contentWindow;this.title=e.document.title,setTimeout(()=>{this.title=e.document.title},500),setTimeout(()=>{this.title=e.document.title},2e3)}}return n.\u0275fac=function(t){return new(t||n)(s.Y36(y.H7))},n.\u0275cmp=s.Xpm({type:n,selectors:[["app-window"]],viewQuery:function(t,e){if(1&t&&s.Gf(V,5),2&t){let a;s.iGM(a=s.CRH())&&(e.iframe=a.first)}},inputs:{title:"title",width:"width",height:"height",url:"url"},decls:3,vars:5,consts:[[4,"nzModalTitle"],[3,"src","load"],["iframe",""]],template:function(t,e){1&t&&(s.YNc(0,T,2,1,"div",0),s.TgZ(1,"iframe",1,2),s.NdJ("load",function(r){return e.load(r)}),s.qZA()),2&t&&(s.xp6(1),s.Udp("width",e.width+"px")("height",e.height+"px"),s.Q6J("src",e.safeUrl,s.uOi))},dependencies:[g.h1],styles:["iframe[_ngcontent-%COMP%]{border:none}"]}),n})();var M=c(1445),R=c(9856),b=c(387),O=c(4838);const W=[{path:":id",component:(()=>{class n{constructor(t,e,a,r,h,p,f,w){function u(i){let o=h.snapshot.queryParams[i];return"true"==o||"1"==o}this.title=t,this.element=e,this.rs=a,this.cs=r,this.route=h,this.ns=p,this.ms=f,this.mqtt=w,this.id="",this.index=0,this.subs=[],this.mousewheel=!1,this.panning=!1,this.full=!1,this.padding=10,this.tools={go:i=>{this.project.pages.forEach(o=>{o.name==i&&this.Render(o)})},window:(i,o=400,d=300,F="\u7a97\u53e3")=>{this.ms.create({nzContent:j,nzComponentParams:{url:i,width:o,height:d,title:F},nzWidth:o+48,nzFooter:null})},open:(i,o=!1)=>{o?window.open(i):location.href=i},get:(i,o)=>{this.rs.get(i,o).subscribe(()=>{})},post:(i,o)=>{this.rs.post(i,o).subscribe(()=>{})}},this.load(),this.mousewheel=u("mousewheel"),this.panning=u("panning"),this.full=u("full"),this.graph=new z.kJ({container:e.nativeElement,interacting:!1,mousewheel:this.mousewheel,panning:this.panning,autoResize:this.full}),this.graph.on("cell:click",({cell:i,e:o})=>{try{i.data?.listeners?.click?.call(this,i,o,this.tools),this.cs.Get(i.shape)?.listeners?.click?.call(this,i,o,this.tools)}catch(d){this.ns.error("\u70b9\u51fb\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:mouseenter",({cell:i,e:o})=>{try{this.cs.Get(i.shape)?.listeners?.mouseenter?.call(this,i,o,this.tools)}catch(d){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:mouseleave",({cell:i,e:o})=>{try{this.cs.Get(i.shape)?.listeners?.mouseleave?.call(this,i,o,this.tools)}catch(d){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:custom",i=>{try{i.cell?.data.listeners?.[i.event]?.call(this,i.cell,i.value,this.tools)}catch(o){this.ns.error("\u7ec4\u4ef6\u4e8b\u4ef6\u54cd\u5e94\u5904\u7406\u9519\u8bef",o.message)}})}evaluate(t,e){const a=Object.keys(e),r=Object.values(e);return new Function(...a,"return "+t)(...r)}Render(t){t.content?.cells?.forEach(e=>{this.cs.Get(e.shape)}),this.graph.drawBackground({color:t.background_color,image:t.background_image}),this.graph.fromJSON(t.content),this.full&&(this.graph.centerContent(),this.graph.zoomToFit({padding:this.padding})),this.subs.forEach(e=>e.unsubscribe()),this.subs=[],this.graph.getCells().forEach(e=>{const a=this.cs.Get(e.shape);if(e.data?.bindings)for(const r in e.data.bindings){if(!e.data.bindings.hasOwnProperty(r))continue;const h=e.data.bindings[r];console.log("binding",a.id,r,h);const f=this.mqtt.observe(`up/property/${h.product}/${h.device}`).subscribe(w=>{const u=JSON.parse(w.payload.toString());console.log("data",a.id,r,h,u);try{a.hooks?.[r]?.call(this,e,u[h.variable])}catch(i){this.ns.error("\u6570\u636e\u7ed1\u5b9a\u9519\u8bef",i.message)}});this.subs.push(f)}if(e.data?.listeners)for(const r in e.data.listeners){if(!e.data.listeners.hasOwnProperty(r))continue;const h=e.data.listeners[r];if("string"==typeof h&&h.length>0)try{e.data.listeners[r]=new Function("cell","event","tools",h)}catch(p){this.ns.error("\u811a\u672c\u7f16\u8bd1\u9519\u8bef"+r,h+" "+p.message),e.data.listeners[r]=()=>{this.ns.error("\u7ec4\u4ef6\u811a\u672c\u9519\u8bef"+r,h+" "+p.message)}}}})}load(){this.id=this.route.snapshot.paramMap.get("id"),this.rs.get(`api/project/${this.id}`).subscribe(t=>{this.project=t.data,this.title.setTitle(this.project.name),this.full?this.graph.resize(window.innerWidth,window.innerHeight):this.graph.resize(this.project.width,this.project.height),this.Render(this.project.pages[0])})}onResize(t){this.full&&(this.graph.resize(t.target.innerWidth,t.target.innerHeight),this.graph.centerContent(),this.graph.zoomToFit({padding:this.padding}))}ngOnDestroy(){this.subs.forEach(t=>t.unsubscribe())}handlePageChange(t){this.Render(this.project.pages[this.index])}}return n.\u0275fac=function(t){return new(t||n)(s.Y36(y.Dx),s.Y36(s.SBq),s.Y36(M.s),s.Y36(R.m),s.Y36(m.gz),s.Y36(b.zb),s.Y36(g.Sf),s.Y36(O.KZ))},n.\u0275cmp=s.Xpm({type:n,selectors:[["app-viewer"]],hostBindings:function(t,e){1&t&&s.NdJ("resize",function(r){return e.onResize(r)},!1,s.Jf7)},decls:0,vars:0,template:function(t,e){},styles:["[_nghost-%COMP%]{display:block;overflow:hidden}"]}),n})()}];let Y=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=s.oAB({type:n}),n.\u0275inj=s.cJS({imports:[m.Bz.forChild(W),m.Bz]}),n})(),B=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=s.oAB({type:n}),n.\u0275inj=s.cJS({imports:[C.ez,Y,b.L8,g.Qp]}),n})()}}]);