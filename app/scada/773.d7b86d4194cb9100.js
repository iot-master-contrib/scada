"use strict";(self.webpackChunkscada=self.webpackChunkscada||[]).push([[773],{773:(F,y,h)=>{h.r(y),h.d(y,{ViewerModule:()=>S});var V=h(6895),g=h(4575),z=h(760),n=h(4650),v=h(1481);let O=(()=>{class e{set url(t){this.safeUrl=this.san.bypassSecurityTrustResourceUrl(t)}constructor(t){this.san=t,this.width=400,this.height=300}}return e.\u0275fac=function(t){return new(t||e)(n.Y36(v.H7))},e.\u0275cmp=n.Xpm({type:e,selectors:[["app-window"]],inputs:{width:"width",height:"height",url:"url"},decls:1,vars:5,consts:[[3,"src"]],template:function(t,s){1&t&&n._UZ(0,"iframe",0),2&t&&(n.Udp("width",s.width+"px")("height",s.height+"px"),n.Q6J("src",s.safeUrl,n.uOi))},styles:["iframe[_ngcontent-%COMP%]{border:none}"]}),e})();var j=h(1445),M=h(7638),b=h(387),C=h(5156),Y=h(4838);const P=[{path:":id",component:(()=>{class e{constructor(t,s,p,r,a,d,f,w){this.title=t,this.element=s,this.rs=p,this.cs=r,this.route=a,this.ns=d,this.ms=f,this.mqtt=w,this.id="",this.index=0,this.subs=[],this.tools={go:i=>{this.project.pages.forEach(o=>{o.name==i&&this.Render(o)})},window:(i,o=400,c=300)=>{this.ms.create({nzContent:O,nzComponentParams:{url:i,width:o,height:c},nzWidth:o+48,nzFooter:null})}};let u=a.snapshot.queryParams.mousewheel,m=a.snapshot.queryParams.panning;this.graph=new z.kJ({container:s.nativeElement,interacting:!1,mousewheel:"true"==u||"1"==u,panning:"true"==m||"1"==m}),this.graph.on("cell:click",({cell:i,e:o})=>{try{i.data.listeners?.click?.call(this,i,o,this.tools),this.cs.Get(i.shape)?.listeners?.click?.call(this,i,o,this.tools)}catch(c){this.ns.error("\u70b9\u51fb\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",c.message)}}),this.graph.on("cell:mouseenter",({cell:i,e:o})=>{try{this.cs.Get(i.shape)?.listeners?.mouseenter?.call(this,i,o,this.tools)}catch(c){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",c.message)}}),this.graph.on("cell:mouseleave",({cell:i,e:o})=>{try{this.cs.Get(i.shape)?.listeners?.mouseleave?.call(this,i,o,this.tools)}catch(c){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",c.message)}}),this.graph.on("cell:custom",i=>{try{i.cell?.data.listeners?.[i.event]?.call(this,i.cell,i.value,this.tools)}catch(o){this.ns.error("\u7ec4\u4ef6\u4e8b\u4ef6\u54cd\u5e94\u5904\u7406\u9519\u8bef",o.message)}})}evaluate(t,s){const p=Object.keys(s),r=Object.values(s);return new Function(...p,"return "+t)(...r)}Render(t){t.content?.cells?.forEach(s=>{this.cs.Get(s.shape)}),this.graph.drawBackground({color:t.background_color,image:t.background_image}),this.graph.fromJSON(t.content),this.subs.forEach(s=>s.unsubscribe()),this.subs=[],this.graph.getCells().forEach(s=>{const p=this.cs.Get(s.shape);if(s.data.bindings)for(const r in s.data.bindings){if(!s.data.bindings.hasOwnProperty(r))continue;const a=s.data.bindings[r];console.log("binding",p.id,r,a);const f=this.mqtt.observe(`up/property/${a.product}/${a.device}`).subscribe(w=>{const u=JSON.parse(w.payload.toString());console.log("data",p.id,r,a,u);try{p.hooks?.[r]?.call(this,s,u[a.variable])}catch(m){this.ns.error("\u6570\u636e\u7ed1\u5b9a\u9519\u8bef",m.message)}});this.subs.push(f)}if(s.data.listeners)for(const r in s.data.listeners){if(!s.data.listeners.hasOwnProperty(r))continue;const a=s.data.listeners[r];if("string"==typeof a&&a.length>0)try{s.data.listeners[r]=new Function("cell","event","tools",a)}catch(d){this.ns.error("\u7f16\u8bd1\u9519\u8bef",d.message)}}})}ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),this.rs.get(`api/project/${this.id}`).subscribe(t=>{this.project=t.data,this.title.setTitle(this.project.name),this.Render(this.project.pages[0])})}ngOnDestroy(){this.subs.forEach(t=>t.unsubscribe())}handlePageChange(t){this.Render(this.project.pages[this.index])}}return e.\u0275fac=function(t){return new(t||e)(n.Y36(v.Dx),n.Y36(n.SBq),n.Y36(j.s),n.Y36(M.m),n.Y36(g.gz),n.Y36(b.zb),n.Y36(C.Sf),n.Y36(Y.KZ))},e.\u0275cmp=n.Xpm({type:e,selectors:[["app-viewer"]],decls:0,vars:0,template:function(t,s){},styles:["[_nghost-%COMP%]{display:block;width:100%!important;height:100%!important}"]}),e})()}];let R=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=n.oAB({type:e}),e.\u0275inj=n.cJS({imports:[g.Bz.forChild(P),g.Bz]}),e})(),S=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=n.oAB({type:e}),e.\u0275inj=n.cJS({imports:[V.ez,R,b.L8,C.Qp]}),e})()}}]);