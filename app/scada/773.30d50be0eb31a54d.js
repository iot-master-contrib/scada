"use strict";(self.webpackChunkscada=self.webpackChunkscada||[]).push([[773],{773:(S,y,c)=>{c.r(y),c.d(y,{ViewerModule:()=>x});var z=c(6895),f=c(4575),M=c(760),e=c(4650),C=c(1481),w=c(5156);const O=["iframe"];function V(s,l){if(1&s&&(e.TgZ(0,"div"),e._uU(1),e.qZA()),2&s){const t=e.oxw();e.xp6(1),e.Oqu(t.title)}}let j=(()=>{class s{set url(t){this.safeUrl=this.san.bypassSecurityTrustResourceUrl(t)}constructor(t){this.san=t,this.title="\u7a97\u53e3",this.width=400,this.height=300}load(t){console.log("iframe load",t),this.title=this.iframe.nativeElement.contentWindow.document.title}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(C.H7))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-window"]],viewQuery:function(t,o){if(1&t&&e.Gf(O,5),2&t){let n;e.iGM(n=e.CRH())&&(o.iframe=n.first)}},inputs:{title:"title",width:"width",height:"height",url:"url"},decls:3,vars:5,consts:[[4,"nzModalTitle"],[3,"src","load"],["iframe",""]],template:function(t,o){1&t&&(e.YNc(0,V,2,1,"div",0),e.TgZ(1,"iframe",1,2),e.NdJ("load",function(d){return o.load(d)}),e.qZA()),2&t&&(e.xp6(1),e.Udp("width",o.width+"px")("height",o.height+"px"),e.Q6J("src",o.safeUrl,e.uOi))},dependencies:[w.h1],styles:["iframe[_ngcontent-%COMP%]{border:none}"]}),s})();var T=c(1445),Y=c(7638),b=c(387),P=c(4838);const R=[{path:":id",component:(()=>{class s{constructor(t,o,n,d,r,h,m,v){this.title=t,this.element=o,this.rs=n,this.cs=d,this.route=r,this.ns=h,this.ms=m,this.mqtt=v,this.id="",this.index=0,this.subs=[],this.tools={go:i=>{this.project.pages.forEach(a=>{a.name==i&&this.Render(a)})},window:(i,a=400,p=300,F="\u7a97\u53e3")=>{this.ms.create({nzContent:j,nzComponentParams:{url:i,width:a,height:p,title:F},nzWidth:a+48,nzFooter:null})},open:(i,a=!1)=>{a?window.open(i):location.href=i}};let g=r.snapshot.queryParams.mousewheel,u=r.snapshot.queryParams.panning;this.graph=new M.kJ({container:o.nativeElement,interacting:!1,mousewheel:"true"==g||"1"==g,panning:"true"==u||"1"==u}),this.graph.on("cell:click",({cell:i,e:a})=>{try{i.data?.listeners?.click?.call(this,i,a,this.tools),this.cs.Get(i.shape)?.listeners?.click?.call(this,i,a,this.tools)}catch(p){this.ns.error("\u70b9\u51fb\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",p.message)}}),this.graph.on("cell:mouseenter",({cell:i,e:a})=>{try{this.cs.Get(i.shape)?.listeners?.mouseenter?.call(this,i,a,this.tools)}catch(p){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",p.message)}}),this.graph.on("cell:mouseleave",({cell:i,e:a})=>{try{this.cs.Get(i.shape)?.listeners?.mouseleave?.call(this,i,a,this.tools)}catch(p){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",p.message)}}),this.graph.on("cell:custom",i=>{try{i.cell?.data.listeners?.[i.event]?.call(this,i.cell,i.value,this.tools)}catch(a){this.ns.error("\u7ec4\u4ef6\u4e8b\u4ef6\u54cd\u5e94\u5904\u7406\u9519\u8bef",a.message)}})}evaluate(t,o){const n=Object.keys(o),d=Object.values(o);return new Function(...n,"return "+t)(...d)}Render(t){t.content?.cells?.forEach(n=>{this.cs.Get(n.shape)}),this.graph.drawBackground({color:t.background_color,image:t.background_image}),this.graph.fromJSON(t.content);let o=this.route.snapshot.queryParams.zoom;("true"==o||"1"==o)&&(this.graph.zoomToFit(),this.graph.centerContent()),this.subs.forEach(n=>n.unsubscribe()),this.subs=[],this.graph.getCells().forEach(n=>{const d=this.cs.Get(n.shape);if(n.data?.bindings)for(const r in n.data.bindings){if(!n.data.bindings.hasOwnProperty(r))continue;const h=n.data.bindings[r];console.log("binding",d.id,r,h);const v=this.mqtt.observe(`up/property/${h.product}/${h.device}`).subscribe(g=>{const u=JSON.parse(g.payload.toString());console.log("data",d.id,r,h,u);try{d.hooks?.[r]?.call(this,n,u[h.variable])}catch(i){this.ns.error("\u6570\u636e\u7ed1\u5b9a\u9519\u8bef",i.message)}});this.subs.push(v)}if(n.data?.listeners)for(const r in n.data.listeners){if(!n.data.listeners.hasOwnProperty(r))continue;const h=n.data.listeners[r];if("string"==typeof h&&h.length>0)try{n.data.listeners[r]=new Function("cell","event","tools",h)}catch(m){this.ns.error("\u811a\u672c\u7f16\u8bd1\u9519\u8bef"+r,h+" "+m.message),n.data.listeners[r]=()=>{this.ns.error("\u7ec4\u4ef6\u811a\u672c\u9519\u8bef"+r,h+" "+m.message)}}}})}ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),this.rs.get(`api/project/${this.id}`).subscribe(t=>{this.project=t.data,this.title.setTitle(this.project.name),this.Render(this.project.pages[0])})}ngOnDestroy(){this.subs.forEach(t=>t.unsubscribe())}handlePageChange(t){this.Render(this.project.pages[this.index])}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(C.Dx),e.Y36(e.SBq),e.Y36(T.s),e.Y36(Y.m),e.Y36(f.gz),e.Y36(b.zb),e.Y36(w.Sf),e.Y36(P.KZ))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-viewer"]],decls:0,vars:0,template:function(t,o){},styles:["[_nghost-%COMP%]{display:block;width:100%!important;height:100%!important}"]}),s})()}];let W=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[f.Bz.forChild(R),f.Bz]}),s})(),x=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[z.ez,W,b.L8,w.Qp]}),s})()}}]);