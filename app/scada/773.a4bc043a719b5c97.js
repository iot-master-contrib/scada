"use strict";(self.webpackChunkscada=self.webpackChunkscada||[]).push([[773],{773:(B,v,c)=>{c.r(v),c.d(v,{ViewerModule:()=>J});var C=c(6895),m=c(4575),z=c(760),s=c(4650),b=c(1481),g=c(5156);const S=["iframe"];function V(i,l){if(1&i&&(s.TgZ(0,"div"),s._uU(1),s.qZA()),2&i){const t=s.oxw();s.xp6(1),s.Oqu(t.title)}}let T=(()=>{class i{set url(t){this.safeUrl=this.san.bypassSecurityTrustResourceUrl(t)}constructor(t){this.san=t,this.title="\u7a97\u53e3",this.width=400,this.height=300}load(t){console.log("iframe load",t);const e=this.iframe.nativeElement.contentWindow;this.title=e.document.title,setTimeout(()=>{this.title=e.document.title},500),setTimeout(()=>{this.title=e.document.title},2e3)}}return i.\u0275fac=function(t){return new(t||i)(s.Y36(b.H7))},i.\u0275cmp=s.Xpm({type:i,selectors:[["app-window"]],viewQuery:function(t,e){if(1&t&&s.Gf(S,5),2&t){let h;s.iGM(h=s.CRH())&&(e.iframe=h.first)}},inputs:{title:"title",width:"width",height:"height",url:"url"},decls:3,vars:5,consts:[[4,"nzModalTitle"],[3,"src","load"],["iframe",""]],template:function(t,e){1&t&&(s.YNc(0,V,2,1,"div",0),s.TgZ(1,"iframe",1,2),s.NdJ("load",function(o){return e.load(o)}),s.qZA()),2&t&&(s.xp6(1),s.Udp("width",e.width+"px")("height",e.height+"px"),s.Q6J("src",e.safeUrl,s.uOi))},dependencies:[g.h1],styles:["iframe[_ngcontent-%COMP%]{border:none}"]}),i})();var j=c(1445),M=c(9985),y=c(387),O=c(4838);const R=[{path:":id",component:(()=>{class i{constructor(t,e,h,o,r,u,f,w){function p(n){let a=r.snapshot.queryParams[n];return"true"==a||"1"==a}this.title=t,this.element=e,this.rs=h,this.cs=o,this.route=r,this.ns=u,this.ms=f,this.mqtt=w,this.id="",this.index=0,this.subs=[],this.mousewheel=!1,this.panning=!1,this.full=!1,this.padding=10,this.tools={go:n=>{this.project.pages.forEach(a=>{a.name==n&&this.Render(a)})},window:(n,a=400,d=300,Y="\u7a97\u53e3")=>{this.ms.create({nzContent:T,nzComponentParams:{url:n,width:a,height:d,title:Y},nzWidth:a+48,nzFooter:null})},open:(n,a=!1)=>{a?window.open(n):location.href=n}},this.alarmSubs=new Set,this.load(),this.mousewheel=p("mousewheel"),this.panning=p("panning"),this.full=p("full"),this.graph=new z.kJ({container:e.nativeElement,interacting:!1,mousewheel:this.mousewheel,panning:this.panning,autoResize:this.full}),this.graph.on("cell:click",({cell:n,e:a})=>{try{n.data?.listeners?.click?.call(this,n,a,this.tools),this.cs.Get(n.shape)?.listeners?.click?.call(this,n,a,this.tools)}catch(d){this.ns.error("\u70b9\u51fb\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:mouseenter",({cell:n,e:a})=>{try{this.cs.Get(n.shape)?.listeners?.mouseenter?.call(this,n,a,this.tools)}catch(d){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:mouseleave",({cell:n,e:a})=>{try{this.cs.Get(n.shape)?.listeners?.mouseleave?.call(this,n,a,this.tools)}catch(d){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",d.message)}}),this.graph.on("cell:custom",n=>{try{n.cell?.data.listeners?.[n.event]?.call(this,n.cell,n.value,this.tools)}catch(a){this.ns.error("\u7ec4\u4ef6\u4e8b\u4ef6\u54cd\u5e94\u5904\u7406\u9519\u8bef",a.message)}})}evaluate(t,e){const h=Object.keys(e),o=Object.values(e);return new Function(...h,"return "+t)(...o)}subscribeAlarm(t){if(this.alarmSubs.has(t))return;this.alarmSubs.add(t);const h=this.mqtt.observe(`alarm/+/${t}`).subscribe(o=>{const r=JSON.parse(o.payload.toString());console.log("alarm",r),this.ns.create("error",r.title,r.device+" "+r.message,{nzPlacement:"top",nzDuration:1e4})});this.subs.push(h)}Render(t){t.content?.cells?.forEach(e=>{this.cs.Get(e.shape)}),this.graph.drawBackground({color:t.background_color,image:t.background_image}),this.graph.fromJSON(t.content),this.full&&(this.graph.centerContent(),this.graph.zoomToFit({padding:this.padding})),this.subs.forEach(e=>e.unsubscribe()),this.subs=[],this.graph.getCells().forEach(e=>{const h=this.cs.Get(e.shape);if(e.data?.bindings)for(const o in e.data.bindings){if(!e.data.bindings.hasOwnProperty(o))continue;const r=e.data.bindings[o];console.log("binding",h.id,o,r);const f=this.mqtt.observe(`up/property/${r.product}/${r.device}`).subscribe(w=>{const p=JSON.parse(w.payload.toString());console.log("data",h.id,o,r,p);try{h.hooks?.[o]?.call(this,e,p[r.variable])}catch(n){this.ns.error("\u6570\u636e\u7ed1\u5b9a\u9519\u8bef",n.message)}});this.subs.push(f),this.subscribeAlarm(r.device)}if(e.data?.listeners)for(const o in e.data.listeners){if(!e.data.listeners.hasOwnProperty(o))continue;const r=e.data.listeners[o];if("string"==typeof r&&r.length>0)try{e.data.listeners[o]=new Function("cell","event","tools",r)}catch(u){this.ns.error("\u811a\u672c\u7f16\u8bd1\u9519\u8bef"+o,r+" "+u.message),e.data.listeners[o]=()=>{this.ns.error("\u7ec4\u4ef6\u811a\u672c\u9519\u8bef"+o,r+" "+u.message)}}}})}load(){this.id=this.route.snapshot.paramMap.get("id"),this.rs.get(`api/project/${this.id}`).subscribe(t=>{this.project=t.data,this.title.setTitle(this.project.name),this.full?this.graph.resize(window.innerWidth,window.innerHeight):this.graph.resize(this.project.width,this.project.height),this.Render(this.project.pages[0])})}onResize(t){this.full&&(this.graph.resize(t.target.innerWidth,t.target.innerHeight),this.graph.centerContent(),this.graph.zoomToFit({padding:this.padding}))}ngOnDestroy(){this.subs.forEach(t=>t.unsubscribe())}handlePageChange(t){this.Render(this.project.pages[this.index])}}return i.\u0275fac=function(t){return new(t||i)(s.Y36(b.Dx),s.Y36(s.SBq),s.Y36(j.s),s.Y36(M.m),s.Y36(m.gz),s.Y36(y.zb),s.Y36(g.Sf),s.Y36(O.KZ))},i.\u0275cmp=s.Xpm({type:i,selectors:[["app-viewer"]],hostBindings:function(t,e){1&t&&s.NdJ("resize",function(o){return e.onResize(o)},!1,s.Jf7)},decls:0,vars:0,template:function(t,e){},styles:["[_nghost-%COMP%]{display:block;overflow:hidden}"]}),i})()}];let W=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=s.oAB({type:i}),i.\u0275inj=s.cJS({imports:[m.Bz.forChild(R),m.Bz]}),i})(),J=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=s.oAB({type:i}),i.\u0275inj=s.cJS({imports:[C.ez,W,y.L8,g.Qp]}),i})()}}]);