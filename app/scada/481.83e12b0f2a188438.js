"use strict";(self.webpackChunkscada=self.webpackChunkscada||[]).push([[481],{4808:(B,v,r)=>{r.r(v),r.d(v,{ViewerModule:()=>z});var y=r(6895),g=r(4575),w=r(760),i=r(4650),b=r(1481),V=r(1445),C=r(431),M=r(387),j=r(4838);const O=[{path:":id",component:(()=>{class t{constructor(s,n,u,a,o,l,f){this.title=s,this.element=n,this.rs=u,this.cs=a,this.route=o,this.ns=l,this.mqtt=f,this.id="",this.index=0,this.subs=[];let d=o.snapshot.queryParams.mousewheel,m=o.snapshot.queryParams.panning;this.graph=new w.kJ({container:n.nativeElement,interacting:!1,mousewheel:"true"==d||"1"==d,panning:"true"==m||"1"==m}),this.graph.on("cell:click",({cell:e,e:c})=>{try{e.data.listeners?.click?.call(this,e,c),this.cs.Get(e.shape)?.listeners?.click?.call(this,e,c)}catch(h){this.ns.error("\u70b9\u51fb\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",h.message)}}),this.graph.on("cell:mouseenter",({cell:e,e:c})=>{try{this.cs.Get(e.shape)?.listeners?.mouseenter?.call(this,e,c)}catch(h){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",h.message)}}),this.graph.on("cell:mouseleave",({cell:e,e:c})=>{try{this.cs.Get(e.shape)?.listeners?.mouseleave?.call(this,e,c)}catch(h){this.ns.error("\u9f20\u6807\u4e8b\u4ef6\u5904\u7406\u9519\u8bef",h.message)}}),this.graph.on("cell:custom",e=>{try{e.cell?.data.listeners?.[e.event]?.call(this,e.cell,e.value)}catch(c){this.ns.error("\u7ec4\u4ef6\u4e8b\u4ef6\u54cd\u5e94\u5904\u7406\u9519\u8bef",c.message)}})}Render(s){s.content?.cells?.forEach(n=>{this.cs.Get(n.shape)}),this.graph.drawBackground({color:s.background_color,image:s.background_image}),this.graph.fromJSON(s.content),this.graph.getCells().forEach(n=>{const u=this.cs.Get(n.shape);for(const a in n.data.bindings){if(!n.data.bindings.hasOwnProperty(a))continue;const o=n.data.bindings[a],l=`up/property/${o.product}/${o.device}`;console.log("subscribe topic",l);const f=this.mqtt.observe(l).subscribe(d=>{const m=JSON.parse(d.payload.toString());console.log("mqtt",l,m);try{u.hooks?.[a]?.call(this,n,m[o.variable])}catch(e){this.ns.error("\u6570\u636e\u7ed1\u5b9a\u9519\u8bef",e.message)}});this.subs.push(f)}for(const a in n.data.listeners){if(!n.data.listeners.hasOwnProperty(a))continue;const o=n.data.listeners[a];if("string"==typeof o&&o.length>0)try{n.data.listeners[a]=new Function("cell","event",o)}catch(l){this.ns.error("\u7f16\u8bd1\u9519\u8bef",l.message)}}})}ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),this.rs.get(`api/project/${this.id}`).subscribe(s=>{this.project=s.data,this.title.setTitle(this.project.name),this.Render(this.project.pages[0])})}ngOnDestroy(){this.subs.forEach(s=>{})}handlePageChange(s){this.Render(this.project.pages[this.index])}}return t.\u0275fac=function(s){return new(s||t)(i.Y36(b.Dx),i.Y36(i.SBq),i.Y36(V.s),i.Y36(C.m),i.Y36(g.gz),i.Y36(M.zb),i.Y36(j.KZ))},t.\u0275cmp=i.Xpm({type:t,selectors:[["app-viewer"]],decls:0,vars:0,template:function(s,n){},styles:["[_nghost-%COMP%]{display:block;width:100%!important;height:100%!important}"]}),t})()}];let Y=(()=>{class t{}return t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=i.oAB({type:t}),t.\u0275inj=i.cJS({imports:[g.Bz.forChild(O),g.Bz]}),t})(),z=(()=>{class t{}return t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=i.oAB({type:t}),t.\u0275inj=i.cJS({imports:[y.ez,Y]}),t})()}}]);